[phases.build]
dependsOn = ['install']
cmds = ['npm run build']

[phases.install]
dependsOn = ['setup']
cmds = [
    'mkdir -p /var/log/nginx && mkdir -p /var/cache/nginx',
    'composer install --ignore-platform-reqs',
    'npm ci',
]

[phases.setup]
nixPkgs = [
    '(php81.withExtensions (pe: pe.enabled ++ []))',
    'nginx',
    'libmysqlclient',
    'php81Packages.composer',
    'nodejs_18',
    'npm-9_x',
]
nixLibs = ['libmysqlclient']
nixOverlays = ['https://github.com/railwayapp/nix-npm-overlay/archive/main.tar.gz']
nixpkgsArchive = '5148520bfab61f99fd25fb9ff7bfbb50dad3c9db'

[start]
cmd = 'node /assets/scripts/prestart.mjs /assets/nginx.template.conf /nginx.conf && (php-fpm -y /assets/php-fpm.conf & nginx -c /nginx.conf)'
